import{W as Ce,j as t,c as Re,b as Ne,r as n,u as Ae,e as ze,_ as R,X as Ee,s as ae,f as Pe,i as Fe,m as Le,n as Be,o as Me,Y as _e,Z as We,$,a0 as qe,P as Z,B as f,a1 as F,a as y,g as O,d as L,a2 as te,a3 as fe,a4 as Te,a5 as xe}from"./index-D6zfUZPM.js";import{a as X,D as me,T as ee}from"./Delete-LWAT4-uP.js";import{r as Ue}from"./createSvgIcon-BiptPAxs.js";import{T as g}from"./Typography-CDEwC3Sn.js";import{B}from"./Button-CfJaqulS.js";import{S as he}from"./logo-jV6IYJtX.js";const Xe=Ce(t.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"}),"Person");function Ye(i){return Re("MuiAvatar",i)}Ne("MuiAvatar",["root","colorDefault","circular","rounded","square","img","fallback"]);const $e=["alt","children","className","component","slots","slotProps","imgProps","sizes","src","srcSet","variant"],Ke=i=>{const{classes:a,variant:d,colorDefault:u}=i;return Fe({root:["root",d,u&&"colorDefault"],img:["img"],fallback:["fallback"]},Ye,a)},Ge=ae("div",{name:"MuiAvatar",slot:"Root",overridesResolver:(i,a)=>{const{ownerState:d}=i;return[a.root,a[d.variant],d.colorDefault&&a.colorDefault]}})(({theme:i})=>({position:"relative",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,width:40,height:40,fontFamily:i.typography.fontFamily,fontSize:i.typography.pxToRem(20),lineHeight:1,borderRadius:"50%",overflow:"hidden",userSelect:"none",variants:[{props:{variant:"rounded"},style:{borderRadius:(i.vars||i).shape.borderRadius}},{props:{variant:"square"},style:{borderRadius:0}},{props:{colorDefault:!0},style:R({color:(i.vars||i).palette.background.default},i.vars?{backgroundColor:i.vars.palette.Avatar.defaultBg}:R({backgroundColor:i.palette.grey[400]},i.applyStyles("dark",{backgroundColor:i.palette.grey[600]})))}]})),He=ae("img",{name:"MuiAvatar",slot:"Img",overridesResolver:(i,a)=>a.img})({width:"100%",height:"100%",textAlign:"center",objectFit:"cover",color:"transparent",textIndent:1e4}),Je=ae(Xe,{name:"MuiAvatar",slot:"Fallback",overridesResolver:(i,a)=>a.fallback})({width:"75%",height:"75%"});function Qe({crossOrigin:i,referrerPolicy:a,src:d,srcSet:u}){const[v,m]=n.useState(!1);return n.useEffect(()=>{if(!d&&!u)return;m(!1);let h=!0;const p=new Image;return p.onload=()=>{h&&m("loaded")},p.onerror=()=>{h&&m("error")},p.crossOrigin=i,p.referrerPolicy=a,p.src=d,u&&(p.srcset=u),()=>{h=!1}},[i,a,d,u]),v}const Y=n.forwardRef(function(a,d){const u=Ae({props:a,name:"MuiAvatar"}),{alt:v,children:m,className:h,component:p="div",slots:N={},slotProps:_={},imgProps:W,sizes:b,src:j,srcSet:c,variant:se="circular"}=u,ie=ze(u,$e);let x=null;const q=Qe(R({},W,{src:j,srcSet:c})),w=j||c,S=w&&q!=="error",D=R({},u,{colorDefault:!S,component:p,variant:se}),A=Ke(D),[T,E]=Ee("img",{className:A.img,elementType:He,externalForwardedProps:{slots:N,slotProps:{img:R({},W,_.img)}},additionalProps:{alt:v,src:j,srcSet:c,sizes:b},ownerState:D});return S?x=t.jsx(T,R({},E)):m||m===0?x=m:w&&v?x=v[0]:x=t.jsx(Je,{ownerState:D,className:A.fallback}),t.jsx(Ge,R({as:p,ownerState:D,className:Pe(A.root,h),ref:d},ie,{children:x}))});var M={},ge;function Ve(){if(ge)return M;ge=1;var i=Le();Object.defineProperty(M,"__esModule",{value:!0}),M.default=void 0;var a=i(Ue()),d=Be();return M.default=(0,a.default)((0,d.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"}),"Edit"),M}var Ze=Ve();const Oe=Me(Ze),et="_discussionContainer_1swtm_1",tt={discussionContainer:et};function lt(i,a){return te($(y,"users",i,"notifications"),a)}function ct({diaryDocId:i,user:a,diaryOwnerId:d,isAdmin:u,itemId:v,mediaType:m}){const[h,p]=n.useState([]),[N,_]=n.useState(""),[W,b]=n.useState(!0),[j,c]=n.useState(null),[se,ie]=n.useState(!1),[x,q]=n.useState(null),[w,S]=n.useState(""),[D,A]=n.useState(!1),[T,E]=n.useState(!1),[z,K]=n.useState((a==null?void 0:a.avatarIcon)||""),[ve,G]=n.useState((a==null?void 0:a.displayName)||(a==null?void 0:a.email)||""),[ye,re]=n.useState(!1),[U,be]=n.useState({}),I=v&&m?`${v}_${m}`:null,H=n.useRef(null),J=n.useRef(null);n.useEffect(()=>{let e;if(b(!0),c(null),I){const s=_e($(y,"sharedDiscussions",I,"comments"),We("createdAt","desc"));e=qe(s,r=>{p(r.docs.map(o=>({id:o.id,...o.data()}))),b(!1)},r=>{console.error("[Firestore] Error in Discussion onSnapshot:",r,"Query:",s),c("Failed to load discussion. "+(r&&r.message?r.message:"")),b(!1)})}else p([]),b(!1);return()=>e&&e()},[I]),n.useEffect(()=>{if(!a)return;(async()=>{try{const s=await O(L(y,"users",a.uid));s.exists()?(G(s.data().displayName||a.email),K(s.data().avatarIcon||"")):G(a.email)}catch{G(a.displayName||a.email||"")}})()},[a]),n.useEffect(()=>{x&&H.current&&H.current.focus()},[x]),n.useEffect(()=>{!x&&J.current&&J.current.focus()},[x]);const oe=async e=>{try{const s=await O(L(y,"users",e.uid));if(s.exists())return s.data().displayName||e.email}catch{}return e.displayName||e.email||""};function Q(e){if(!e)return"#90caf9";let s=0;for(let o=0;o<e.length;o++)s=e.charCodeAt(o)+((s<<5)-s);return`hsl(${s%360}, 70%, 60%)`}function V(e){return e&&e.avatarIcon?e.avatarIcon:e&&e.displayName?e.displayName[0].toUpperCase():e&&e.email?e.email[0].toUpperCase():"?"}function je({value:e,onChange:s}){const r=["😀","😎","🐱","🐶","🌟","🍕","🎬","📺","🎮","🚀","❤️","🔥"];return t.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1,mt:1,overflowX:"auto",maxWidth:"100%",pb:1},children:[t.jsx(f,{sx:{display:"flex",gap:1,minWidth:0,flexWrap:"nowrap",overflowX:"auto"},children:r.map(o=>t.jsx(F,{onClick:()=>s(o),size:"small",children:t.jsx(Y,{sx:{bgcolor:"#fff",color:"#222",border:e===o?"2px solid #1976d2":"none"},children:o})},o))}),t.jsx(ee,{size:"small",placeholder:"Custom",value:e,onChange:o=>s(o.target.value),sx:{width:56,flexShrink:0},inputProps:{maxLength:2,style:{textAlign:"center"}}})]})}const ne=async()=>{if(N.trim()){if(!a)return c("You must be signed in to comment.");b(!0);try{const e=await oe(a);await te($(y,"sharedDiscussions",I,"comments"),{text:N.trim(),createdAt:fe(),userId:a.uid,displayName:e,avatarIcon:z,parentId:null,reactions:{}}),_("")}catch{c("Failed to post comment.")}b(!1)}},le=async e=>{try{if(I){const s=[e],r=o=>{h.forEach(k=>{k.parentId===o&&(s.push(k.id),r(k.id))})};r(e),await Promise.all(s.map(o=>Te(L(y,"sharedDiscussions",I,"comments",o))))}}catch{c("Failed to delete comment or replies.")}},Ie=async(e,s)=>{var r;if(!a)return c("You must be signed in to react.");if(["👍","👎"].includes(s))try{const o=L(y,"sharedDiscussions",I,"comments",e),k=await O(o);if(!k.exists())return;const P=k.data();let l=P.reactions||{};["👍","👎"].forEach(C=>{l[C]||(l[C]=[]),l[C]=l[C].filter(ke=>ke!==a.uid)}),(!((r=P.reactions)!=null&&r[s])||!P.reactions[s].includes(a.uid))&&l[s].push(a.uid),await xe(o,{reactions:l})}catch{c("Failed to update emoji reaction.")}},ce=e=>e.reactions||{},de=(e,s)=>t.jsx(t.Fragment,{children:["👍","👎"].map(r=>t.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:.5},children:[t.jsx(F,{size:"small",onClick:()=>Ie(e,r),children:t.jsx("span",{style:{fontSize:18},children:r})}),t.jsx(g,{variant:"caption",sx:{ml:.2},children:(s[r]||[]).length})]},r))}),we=h.reduce((e,s)=>(s.parentId&&(e[s.parentId]||(e[s.parentId]=[]),e[s.parentId].push(s)),e),{}),ue=(e,s=1)=>{const r=we[e]||[],P=Math.min(s,4)*18;return r.map(l=>{var C;return t.jsxs(Z,{sx:{p:1,mb:1,bgcolor:"background.default",ml:`${P}px`,width:"100%",maxWidth:"100vw",overflowX:"visible",wordBreak:"break-word",boxSizing:"border-box"},children:[t.jsxs(he,{direction:"row",alignItems:"center",spacing:1,children:[t.jsx(X,{title:l.displayName,children:t.jsx(Y,{sx:{bgcolor:Q(l.displayName),width:24,height:24,fontSize:15,mr:1},children:l.avatarIcon||V(l)})}),t.jsx(g,{variant:"caption",color:"text.secondary",sx:{ml:1},children:(C=l.createdAt)!=null&&C.toDate?l.createdAt.toDate().toLocaleString():""}),((a==null?void 0:a.uid)===l.userId||u)&&t.jsx(X,{title:"Delete reply",children:t.jsx(F,{size:"small",onClick:()=>le(l.id),sx:{color:"error.main",ml:1},children:t.jsx(me,{fontSize:"small"})})}),t.jsx(f,{sx:{flexGrow:1}}),t.jsx(f,{sx:{display:"flex",alignItems:"center",gap:1,justifyContent:"flex-end",minWidth:0,flexShrink:0},children:de(l.id,ce(l))})]}),t.jsx(g,{variant:"body2",sx:{mt:.5,wordBreak:"break-word"},children:l.text}),U[l.id]&&ue(l.id,s+1)]},l.id)})},pe=async e=>{if(w.trim()){if(!a)return c("You must be signed in to reply.");A(!0);try{const s=await oe(a);await te($(y,"sharedDiscussions",I,"comments"),{text:w.trim(),createdAt:fe(),userId:a.uid,displayName:s,avatarIcon:z,parentId:e,reactions:{}}),S("")}catch{c("Failed to post reply.")}A(!1)}},Se=async()=>{if(a){re(!0);try{await xe(L(y,"users",a.uid),{avatarIcon:z}),a.avatarIcon=z,E(!1)}catch{c("Failed to update avatar.")}re(!1)}},De=e=>{be(s=>({...s,[e]:!s[e]})),U[e]?(q(null),S("")):(q(e),S(""))};return t.jsxs(Z,{variant:"outlined",sx:{mt:2,p:2},children:[t.jsx(g,{variant:"h6",sx:{mb:1},children:"Discussion"}),t.jsxs(f,{sx:{display:"flex",alignItems:"center",mb:1},children:[t.jsx(Y,{sx:{bgcolor:Q(ve),width:36,height:36,mr:1},children:z||V(a)}),t.jsx(F,{size:"small",onClick:()=>E(!0),children:t.jsx(Oe,{fontSize:"small"})})]}),T&&t.jsx(je,{value:z,onChange:e=>K(e)}),T&&t.jsxs(f,{sx:{display:"flex",gap:1,mt:1},children:[t.jsx(B,{size:"small",variant:"contained",onClick:Se,disabled:ye,children:"Save"}),t.jsx(B,{size:"small",variant:"text",onClick:()=>{E(!1),K(a.avatarIcon||"")},children:"Cancel"})]}),t.jsx(f,{className:tt.discussionContainer,sx:{maxHeight:300,overflowY:"auto",mb:2,p:1,bgcolor:"background.paper",borderRadius:2,border:"1px solid",borderColor:"divider",width:"100%",overflowX:"hidden"},children:W?t.jsx(g,{variant:"body2",children:"Loading..."}):j?t.jsx(g,{color:"error",variant:"body2",children:j}):h.length===0?t.jsx(g,{variant:"body2",color:"text.secondary",children:"No comments yet."}):h.filter(e=>!e.parentId).map(e=>{var s;return t.jsxs(Z,{sx:{p:1,mb:2,bgcolor:"background.paper",width:"100%",maxWidth:"100vw",overflowX:"visible",wordBreak:"break-word",boxSizing:"border-box"},children:[t.jsxs(he,{direction:"row",alignItems:"center",spacing:1,children:[t.jsx(X,{title:e.displayName,children:t.jsx(Y,{sx:{bgcolor:Q(e.displayName),width:28,height:28,fontSize:18,mr:1},children:e.avatarIcon||V(e)})}),t.jsx(g,{variant:"caption",color:"text.secondary",sx:{ml:1},children:(s=e.createdAt)!=null&&s.toDate?e.createdAt.toDate().toLocaleString():""}),((a==null?void 0:a.uid)===e.userId||u)&&t.jsx(X,{title:"Delete comment",children:t.jsx(F,{size:"small",onClick:()=>le(e.id),sx:{color:"error.main",ml:1},children:t.jsx(me,{fontSize:"small"})})}),t.jsx(f,{sx:{flexGrow:1}}),t.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1,justifyContent:"flex-end",minWidth:0,flexShrink:0},children:[de(e.id,ce(e)),t.jsx(B,{size:"small",variant:"text",sx:{ml:1},onClick:()=>De(e.id),children:"Replies"})]})]}),t.jsx(g,{variant:"body2",sx:{mt:.5,wordBreak:"break-word"},children:e.text}),U[e.id]&&t.jsxs(f,{sx:{display:"flex",gap:1,mt:1},children:[t.jsx(ee,{inputRef:H,value:x===e.id?w:"",onChange:r=>S(r.target.value),size:"small",fullWidth:!0,placeholder:"Write a reply...",disabled:D,onKeyDown:r=>{r.key==="Enter"&&pe(e.id)}}),t.jsx(B,{variant:"contained",size:"small",onClick:()=>pe(e.id),disabled:!w.trim()||D,children:"Send"})]}),U[e.id]&&ue(e.id)]},e.id)})}),t.jsxs(f,{sx:{display:"flex",gap:1},children:[t.jsx(ee,{inputRef:J,value:N,onChange:e=>_(e.target.value),size:"small",fullWidth:!0,placeholder:"Add a comment...",onKeyDown:e=>{e.key==="Enter"&&ne()}}),t.jsx(B,{variant:"contained",size:"small",onClick:ne,disabled:!N.trim(),children:"Send"})]}),j&&t.jsx(g,{color:"error",sx:{mt:1},children:j})]})}export{ct as D,lt as c};
